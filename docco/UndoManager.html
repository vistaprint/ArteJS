<!DOCTYPE html>

<html>
<head>
  <title>UndoManager.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="Arte.html">
                Arte.js
              </a>
            
              
              <a class="source" href="Commands.html">
                Commands.js
              </a>
            
              
              <a class="source" href="Configuration.html">
                Configuration.js
              </a>
            
              
              <a class="source" href="PluginManager.html">
                PluginManager.js
              </a>
            
              
              <a class="source" href="TextArea.html">
                TextArea.js
              </a>
            
              
              <a class="source" href="Util.html">
                Util.js
              </a>
            
              
              <a class="source" href="jquery-dom-cleanup.html">
                jquery-dom-cleanup.js
              </a>
            
              
              <a class="source" href="jquery-dom-manipulation.html">
                jquery-dom-manipulation.js
              </a>
            
              
              <a class="source" href="jquery-dom-traversal.html">
                jquery-dom-traversal.js
              </a>
            
              
              <a class="source" href="rangy-blockElementApplier.html">
                rangy-blockElementApplier.js
              </a>
            
              
              <a class="source" href="rangy-elementApplierOptions.html">
                rangy-elementApplierOptions.js
              </a>
            
              
              <a class="source" href="rangy-extensions.html">
                rangy-extensions.js
              </a>
            
              
              <a class="source" href="rangy-inlineElementApplier.html">
                rangy-inlineElementApplier.js
              </a>
            
              
              <a class="source" href="richtextCommandApplier.html">
                richtextCommandApplier.js
              </a>
            
              
              <a class="source" href="InsertCommand.html">
                InsertCommand.js
              </a>
            
              
              <a class="source" href="StateDetector.html">
                StateDetector.js
              </a>
            
              
              <a class="source" href="UndoManager.html">
                UndoManager.js
              </a>
            
              
              <a class="source" href="keyboardEventHandler.html">
                keyboardEventHandler.js
              </a>
            
              
              <a class="source" href="pasteHandler.html">
                pasteHandler.js
              </a>
            
              
              <a class="source" href="Button.html">
                Button.js
              </a>
            
              
              <a class="source" href="ButtonWithDialog.html">
                ButtonWithDialog.js
              </a>
            
              
              <a class="source" href="ButtonWithDropDown.html">
                ButtonWithDropDown.js
              </a>
            
              
              <a class="source" href="Configuration.html">
                Configuration.js
              </a>
            
              
              <a class="source" href="SelectionManager.html">
                SelectionManager.js
              </a>
            
              
              <a class="source" href="toolbar.html">
                toolbar.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>UndoManager.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>﻿<span class="hljs-comment">/**
 * @fileoverview: UndoManager plugin is a naive implementation to manage undo/redo information from a text area
 * TODO: Evaluate https://code.google.com/p/google-diff-match-patch/ for computing diffs.
 */</span>
(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(pluginManager)</span> </span>{
    <span class="hljs-comment">/**
     * Apply undo/redo commands
     * param {bool} isUndo Whether to perform undo command
     */</span>
    <span class="hljs-keyword">var</span> applyUndoCommand = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(isUndo)</span> </span>{
        <span class="hljs-keyword">var</span> hasInfo = isUndo ? <span class="hljs-keyword">this</span>.hasUndo() : <span class="hljs-keyword">this</span>.hasRedo();
        <span class="hljs-keyword">if</span> (!hasInfo) {
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">var</span> eventNames = $.Arte.constants.eventNames;
        <span class="hljs-keyword">var</span> data = {
            execute: <span class="hljs-literal">true</span>
        };
        <span class="hljs-keyword">this</span>.triggerEvent(isUndo ? eventNames.onbeforeundo : eventNames.onbeforeredo, data);
        <span class="hljs-keyword">if</span> (data.execute) {</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>perform undo</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">this</span>.undoInfo.index += isUndo ? -<span class="hljs-number">1</span> : <span class="hljs-number">1</span>;
            <span class="hljs-keyword">this</span>.outerValue(<span class="hljs-keyword">this</span>.undoInfo.stack[<span class="hljs-keyword">this</span>.undoInfo.index]);
        }
        <span class="hljs-keyword">this</span>.triggerEvent(isUndo ? eventNames.onundo : eventNames.onredo, {});
    };

    <span class="hljs-comment">/**
     * Inserts undo data when the onvaluechange event is raised.  The data can be changed by typing into the field or
     * through a rich text command.  Listening to onvaluechange command simplifies the undo/redo functionality.
     * @param {jQuery event} e
     * @param {Arte event data} data
     */</span>
    <span class="hljs-keyword">var</span> insertUndoData = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e, data)</span> </span>{
        <span class="hljs-keyword">var</span> textArea = data.textArea;
        <span class="hljs-keyword">var</span> undoInfo = textArea.undoInfo;
        <span class="hljs-keyword">var</span> currentValue = $.trim(textArea.outerValue());</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>If the top of the stack is same as the new value, don”t add that to the undo stack
Note that the changes to the DOM are raised as delay change event removing and then
adding the value change event handler doesn”t help.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (currentValue != undoInfo.stack[undoInfo.index]) {
            <span class="hljs-keyword">var</span> index = ++textArea.undoInfo.index;
            <span class="hljs-keyword">var</span> undoStack = textArea.undoInfo.stack;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Remove all the entries after the current position (for example: change after undo)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            undoStack.splice(index, undoStack.length);
            undoStack.push(currentValue);
        }
    };
    <span class="hljs-comment">/**
     * This is Public API that is exposed on the Arte Text Area
     */</span>
    <span class="hljs-keyword">var</span> publicApi = {
        <span class="hljs-comment">/**
         * Whether undo manager can undo
         */</span>
        hasUndo: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.undoInfo.stack.length &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-keyword">this</span>.undoInfo.index &gt; <span class="hljs-number">0</span>;
        },
        <span class="hljs-comment">/**
         * Whether undo manager can redo
         */</span>
        hasRedo: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.undoInfo.stack.length &gt; <span class="hljs-number">0</span> &amp;&amp; (<span class="hljs-keyword">this</span>.undoInfo.index &lt; <span class="hljs-keyword">this</span>.undoInfo.stack.length - <span class="hljs-number">1</span>);
        },
        <span class="hljs-comment">/**
         * Perform undo
         */</span>
        undo: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
            applyUndoCommand.call(<span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
        },
        <span class="hljs-comment">/**
         * Perform redo
         */</span>
        redo: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
            applyUndoCommand.call(<span class="hljs-keyword">this</span>, <span class="hljs-literal">false</span>);
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Extend the prototype of the TextArea to expose the public API</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $.extend($.Arte.TextArea.prototype, publicApi);</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Set of events raised by this plugin</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $.extend($.Arte.constants.eventNames, {
        <span class="hljs-string">"onbeforeundo"</span>: <span class="hljs-string">"onbeforeundo"</span>,
        <span class="hljs-string">"onundo"</span>: <span class="hljs-string">"onundo"</span>,
        <span class="hljs-string">"onbeforeredo"</span>: <span class="hljs-string">"onbeforeredo"</span>,
        <span class="hljs-string">"onredo"</span>: <span class="hljs-string">"onredo"</span>
    });

    <span class="hljs-keyword">var</span> undoManager = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> {
            <span class="hljs-comment">/**
             * A callback method for when a Arte is initialized
             * @param {TextArea} textArea.  An instance of a Arte text area
             */</span>
            init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(textArea)</span> </span>{
                textArea.undoInfo = textArea.undoInfo || {
                    stack: [],
                    index: -<span class="hljs-number">1</span>
                };

                textArea.$element.on({
                    onvaluechange: insertUndoData
                });
            }
        };
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Register this plugin with the plugin manager</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    pluginManager.register(<span class="hljs-string">"undoManager"</span>, undoManager);
})($.Arte.pluginManager);</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
